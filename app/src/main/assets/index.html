<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/ol.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css" >
    <script src="./build/ol.js"></script>
    <script src="scripts/utils.js"></script>
    <title>carte campus</title>
</head>
<body>
<h2>My Map</h2>
<div id="map" class="map"></div>
<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
</div>
<div id="err" style="display: none;"></div>

<script type="text/javascript">
    //adresse du geoserver
    const addr = Android.getGeoServerIp();

    //TGCM sinon ca marche pas sur mon portable
    const requestAnimationFrame = window.requestAnimationFrame
        || window.webkitRequestAnimationFrame
        || window.mozRequestAnimationFrame
        || window.msRequestAnimationFrame
        || function(callback) { return setTimeout(callback, 1000 / 60); };

    //recuperation des capabilities
    const caps = new ol.format.WMTSCapabilities().read(httpGet('http://'+ addr +':8080/geoserver/gwc/service/wmts?request=getcapabilities'));
    //on recupere les different layers
    //console.log(caps);
    const batimentLayer = getVectorLayer(caps,'projetSIG:batimentsBis',batimentStyle);
    const natureLayer = getVectorLayer(caps,'projetSIG:nature',natureStyle);
    const routeLayer = getVectorLayer(caps,'projetSIG:voies',voieStyle);
    routeLayer.setMaxResolution(1/100000); // cache les route avant un certain niveau de zoom

    //on definit la map
    const map = new ol.Map({
        layers: [natureLayer, routeLayer, batimentLayer],
        target: 'map',
        view: new ol.View({
            projection: 'EPSG:4326',
            center: [1.9395,47.8438],
            zoom: 16,
            extent: [1.92377,47.83913,1.94151,47.84943]
        })
    });
    map.getView().setMinZoom(15);
    //definit les limite de chaque layer
    map.getLayers().getArray()[0].setExtent([1.92377,47.83913,1.94151,47.84943]);
    map.getLayers().getArray()[1].setExtent([1.92377,47.83913,1.94151,47.84943]);
    map.getLayers().getArray()[2].setExtent([1.92377,47.83913,1.94151,47.84943]);

    //console.log(map.getView().getResolution());

    //recupere les coordonée de l'utilisateur
    const geolocation = new ol.Geolocation({
        // enableHighAccuracy must be set to true to have the heading value.
        tracking: true,
        trackingOptions: {
            enableHighAccuracy: true
        },
        projection: map.getView().getProjection()
    });

    //gestion des erreur de geolocation
    geolocation.on('error', function(error) {
        const info = document.getElementById('err');
        info.innerHTML = error.message;
        info.style.display = '';
    });

    //met a jours le centre de la carte apres le chargement de la position
    var centre = false;
    geolocation.on('change', function() {
        //on centre la carte si c'est pas deja mais on ne la recentre pas ensuite
        if(!centre){
            centre = true;
            map.getView().setCenter(geolocation.getPosition());
        }
    });

    //gere l'accuraycy ?
    const accuracyFeature = new ol.Feature();
    geolocation.on('change:accuracyGeometry', function() {
        accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
    });

    //gestion de la position
    const positionFeature = new ol.Feature();
    positionFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({
                color: '#3399CC'
            }),
            stroke: new ol.style.Stroke({
                color: '#fff',
                width: 2
            })
        })
    }));

    //update la position
    geolocation.on('change:position', function() {
        const coordinates = geolocation.getPosition();
        positionFeature.setGeometry(coordinates ?
            new ol.geom.Point(coordinates) : null);
    });

    //ajout de la position sur la carte
    map.addLayer(new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [accuracyFeature, positionFeature]
        })
    }));

    var vectorSource = new ol.source.Vector({ });

    var datas = JSON.parse(Android.getMarkersAsJson());
    var markersDict = {};
    var keyIndex = 0;

    for (var marker in datas)
    {
        markersDict[Object.keys(datas)[keyIndex]] = [datas[marker].nom, datas[marker].tag];

        var markerFeature = new ol.Feature({
            type: 'marker',
            geometry: new ol.geom.Point([datas[marker].lon, datas[marker].lat]),
            id : Object.keys(datas)[keyIndex]
        });
        keyIndex++;

        vectorSource.addFeature(markerFeature);
    }

    var markers = new ol.layer.Vector({
        source : vectorSource,
        style : markerStyle
    });

    map.addLayer(markers);

    //Composants du popup
    const container = document.getElementById('popup');//le pop-up
    const content = document.getElementById('popup-content');//le contenut du pop-up
    const closer = document.getElementById('popup-closer');//la croix qui ferme le pop-up

    //overlay pour positionner le popup
    const overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    });
    map.addOverlay(overlay);

    /**
     * Add a click handler to hide the popup.
     * @return {boolean} Don't follow the href.
     */
    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();

        if (flagMarkerInInstance != 0)
        {
            vectorSource.removeFeature(marker);
            flagMarkerInInstance = 0;
        }

        return false;
    };

    function enregistrerMarker()
    {
        var markerName = document.getElementById("markerNom").value;
        var markerTag = document.getElementById("markerTag").value;

        if (markerName == "")
        {
            closer.onclick();
        }
        else
        {
            var markerCoords = marker.getGeometry().getCoordinates();
            Android.insertMarker(markerCoords[0], markerCoords[1], markerName, markerTag);
            flagMarkerInInstance = 0;
            closer.onclick();
        }

    }

    var marker;
    var markerNom;
    var flagMarkerInInstance = 0;

    var target;
    map.on('singleclick', function(evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
            return feature;
        });

        if (flagMarkerInInstance != 0) {
            vectorSource.removeFeature(marker);
            flagMarkerInInstance = 0;
        }

        var touchCoordinates = evt.coordinate;
        marker = new ol.Feature({
            type: 'icon',
            geometry: new ol.geom.Point(touchCoordinates)
        });

        if (feature) {

            const feat = feature.properties_;
            if (feat) {
                if (feat.layer === 'batiments') {
                    const name = feat.name;
                    const distance = distanceBetween(evt.coordinate,geolocation.getPosition());
                    content.innerHTML = '<p> nom: ' + name + '</p>'
                                        +'<p>coordonée: '+evt.coordinate+'</p>'
                                        +'<p>distance: '+distance+'</p>'
                                        +'<button onclick="goTo()"> go !</button>';
                    target = feature;
                    overlay.setPosition(evt.coordinate);
                }
                else if (feat.layer === 'markers')
                {

                }
                else {
                    flagMarkerInInstance = 1;
                    vectorSource.addFeature(marker);
                    showMarkerPopup(content, overlay, evt);
                }
            }
            else {
                //Android.logFromJs("touch");
                if (feature.get("type") == "marker")
                {
                    content.innerHTML = 'Nom : <input type="text" id="markerNom" size="10"><br>'
                            + 'Tag : <input type="text" id="markerTag" size="10"><br>'
                            + '<button onClick="enregistrerMarker()">Enregistrer</button>';

                    var markerId = feature.get("id");
                    document.getElementById("markerNom").value = markersDict[markerId][0];
                    document.getElementById("markerTag").value = markersDict[markerId][1];

                    overlay.setPosition(evt.coordinate);
                }
                /* */
                //getKeys -> type, geometry, id
            }
        }
        else {
            flagMarkerInInstance = 1;
            vectorSource.addFeature(marker);
            showMarkerPopup(content, overlay, evt);
        }
    });

</script>
</body>
</html>
